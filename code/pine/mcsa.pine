//@version=6
indicator("Minervini-Chartist Scoring Algorithm (MCSA)", overlay=true)

// === INPUTS ===
// === FUNDAMENTALS (using request.financial, may be na for many tickers) ===
// Helper to check for missing data
fundamental_na = false

// Price/Earnings Ratio (PE)
eps = request.financial(syminfo.tickerid, "EARNINGS_PER_SHARE", "TTM")
pe_ratio = not na(eps) and eps != 0 ? close / eps : na
fundamental_na := fundamental_na or na(pe_ratio)

// Price/Book Ratio (PB)
bvps = request.financial(syminfo.tickerid, "BOOK_VALUE_PER_SHARE", "FQ")
pb_ratio = not na(bvps) and bvps != 0 ? close / bvps : na
fundamental_na := fundamental_na or na(pb_ratio)

// Debt/Equity Ratio
debt = request.financial(syminfo.tickerid, "TOTAL_DEBT", "FQ")
equity = request.financial(syminfo.tickerid, "TOTAL_EQUITY", "FQ")
debt_equity = not na(debt) and not na(equity) and equity != 0 ? debt / equity : na
fundamental_na := fundamental_na or na(debt_equity)

// Return on Equity (ROE)
roe = request.financial(syminfo.tickerid, "RETURN_ON_EQUITY", "FQ")
fundamental_na := fundamental_na or na(roe)

// Net Margin
net_margin = request.financial(syminfo.tickerid, "NET_MARGIN", "FQ")
fundamental_na := fundamental_na or na(net_margin)

// Revenue Growth (YoY)
rev_growth_qoq = request.financial(syminfo.tickerid, "REVENUE_ONE_YEAR_GROWTH", "FQ")
fundamental_na := fundamental_na or na(rev_growth_qoq)

// Earnings Growth (YoY)
earnings_growth_qoq = request.financial(syminfo.tickerid, "EARNINGS_PER_SHARE_BASIC_ONE_YEAR_GROWTH", "FQ")
fundamental_na := fundamental_na or na(earnings_growth_qoq)


// === TECHNICALS ===
price = close
ma_50 = ta.sma(close, 50)
ma_150 = ta.sma(close, 150)
ma_200 = ta.sma(close, 200)
low_52w = ta.lowest(low, 252)
high_52w = ta.highest(high, 252)

// 200MA trending up for 1 month (20 trading days)
ma_200_trend_up_1m = ma_200 > ta.lowest(ma_200, 20)

// ATRs
atr = ta.atr(14)
atr_20 = ta.sma(atr, 20)
atr_50 = ta.sma(atr, 50)

// Price range contraction (VCP)
price_range_3w = ta.highest(high, 15) - ta.lowest(low, 15)
price_range_prev_3w = ta.highest(high[15], 15) - ta.lowest(low[15], 15)

// Volume dry-up
volume_quiet = ta.sma(volume, 3)
volume_50d_avg = ta.sma(volume, 50)

// === PROGRAMMATIC BONUS CRITERIA ===
// All technicals true for current bar
all_technical = price > ma_150 and price > ma_200 and ma_150 > ma_200 and ma_200_trend_up_1m and ma_50 > ma_150 and ma_50 > ma_200 and price > ma_50 and (price > low_52w * 1.3 and price >= high_52w * 0.75)
// Entered template in last 20 bars (first time)
entered_template_last_20d = ta.change(all_technical ? 1 : 0) == 1 and ta.barssince(all_technical) <= 20
// Volume breakout: volume > 1.5x 50d avg and price breaks out above 20-bar high
volume_breakout = (volume > 1.5 * volume_50d_avg) and (close > ta.highest(close[1], 20))

// === PHASE 1: TECHNICAL FILTER ===
technical_checks = array.new_bool()
array.push(technical_checks, price > ma_150)
array.push(technical_checks, price > ma_200)
array.push(technical_checks, ma_150 > ma_200)
array.push(technical_checks, ma_200_trend_up_1m)
array.push(technical_checks, ma_50 > ma_150)
array.push(technical_checks, ma_50 > ma_200)
array.push(technical_checks, price > ma_50)
array.push(technical_checks, price > low_52w * 1.3 and price >= high_52w * 0.75)
// Helper: Convert bool array to float array
f_bool_to_float_array(arr) =>
    float_arr = array.new_float(array.size(arr), 0.0)
    for i = 0 to array.size(arr) - 1
        array.set(float_arr, i, array.get(arr, i) ? 1.0 : 0.0)
    float_arr

technical_score = array.size(technical_checks) > 0 ? array.sum(f_bool_to_float_array(technical_checks)) / array.size(technical_checks) : na

// === PHASE 2: FUNDAMENTAL FILTER ===
fundamental_checks = array.new_bool()
array.push(fundamental_checks, pe_ratio >= 5 and pe_ratio <= 50)
array.push(fundamental_checks, pb_ratio <= 5)
array.push(fundamental_checks, debt_equity <= 1.0)
array.push(fundamental_checks, roe >= 15)
array.push(fundamental_checks, net_margin >= 10)
array.push(fundamental_checks, rev_growth_qoq > 0)
array.push(fundamental_checks, earnings_growth_qoq > 0)
fundamental_score = array.size(fundamental_checks) > 0 ? array.sum(f_bool_to_float_array(fundamental_checks)) / array.size(fundamental_checks) : na

// === PHASE 3: VCP & TIMING ===
vcp_checks = array.new_bool()
array.push(vcp_checks, atr < atr_20 and atr_20 < atr_50)
array.push(vcp_checks, price_range_3w <= price_range_prev_3w * 0.8)
array.push(vcp_checks, volume_quiet <= volume_50d_avg * 0.8)
array.push(vcp_checks, math.abs(price - ma_50) <= ma_50 * 0.05)
vcp_score = array.size(vcp_checks) > 0 ? array.sum(f_bool_to_float_array(vcp_checks)) / array.size(vcp_checks) : na

// === PHASE 4: BONUS ===
bonus = 0.0
if entered_template_last_20d
    bonus += 10
if volume_breakout
    bonus += 5
bonus := math.min(bonus, 15)

// === TOTAL SCORE ===
total_score = technical_score * 40 + fundamental_score * 35 + vcp_score * 15 + bonus

// === DECISION MATRIX ===
category = total_score >= 85 ? "Mükemmel Setup" : total_score >= 70 ? "Güçlü Setup" : total_score >= 55 ? "Orta Setup" : "Zayıf Setup"

// === PLOT ===
plotshape(category == "Mükemmel Setup", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, title="Mükemmel Setup")
plotshape(category == "Güçlü Setup", style=shape.triangleup, location=location.belowbar, color=color.blue, size=size.tiny, title="Güçlü Setup")
plotshape(category == "Orta Setup", style=shape.triangleup, location=location.belowbar, color=color.orange, size=size.tiny, title="Orta Setup")
plotshape(category == "Zayıf Setup", style=shape.triangledown, location=location.abovebar, color=color.red, size=size.tiny, title="Zayıf Setup")

// === TABLE OUTPUT ===
if barstate.islast
    var table t = table.new(position.top_center, 1, 1)
    table.cell(t, 0, 0, "MCSA Score: " + str.tostring(total_score, format.mintick) + "\nCategory: " + category, bgcolor=color.new(color.black, 0), text_color=color.white)
    if fundamental_na
        table.cell(t, 0, 0, "⚠️ Some fundamental data is missing (na). Results may be incomplete.", bgcolor=color.new(color.red, 80), text_color=color.white)
